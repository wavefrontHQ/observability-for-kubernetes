version: '2'

services:
  zookeeper:
    image: 'bitnami/zookeeper:latest'
    ports:
    - '2181:2181'
    environment:
      ALLOW_ANONYMOUS_LOGIN:
        yes
  kafka:
    image: docker.io/bitnami/kafka:3.5
    ports:
    - "9092:9092"
    hostname: kafka
    environment:
    # KRaft settings
    - KAFKA_CFG_NODE_ID=0
    - KAFKA_CFG_PROCESS_ROLES=controller,broker
    - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
    # Listeners
    - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
    - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://:9092
    - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
    - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
    - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
  postgres:
    image: postgres
    hostname: postgres
    ports:
    - "5432:5432"
    environment:
    - POSTGRES_HOST_AUTH_METHOD=trust
  lemans-resource-server:
    image: lemans/lemans-resources
    ports:
    - "8001:8001"
    hostname: resources
    command: "bash /opt/le-mans/bin/start-resources.sh --cspUri=https://console-stg.cloud.vmware.com"
    environment:
    # KRaft settings
    - BINDING_ADDRESS=0.0.0.0
    - BINDING_PORT=8001
    - LEMS_HOME=tmp
    - PUBLIC_URI=http://localhost:8001
    - DB_CONFIG_FILE=/opt/le-mans/tmp/dbconfig
    volumes:
    - "./tmp:/opt/le-mans/tmp"
  lemans-gateway:
    image: lemans/lemans-gateway
    ports:
    - "8002:8002"
    hostname: localhost
    command: "bash /opt/le-mans/bin/start-gateway.sh --cspUri=https://console-stg.cloud.vmware.com"
    environment:
    # KRaft settings
    - BINDING_ADDRESS=0.0.0.0
    - BINDING_PORT=8002
    - RESOURCES_HOST_URI=http://resources:8001
    - CSP_CLIENT_ID=hnIsmQ7VH1JPvshExJMmEY7Hm1FAxLstxOI
    - CSP_CLIENT_SECRET=qmbXDu16NH7UOwq67jwPhIqmNydGWmZADTiY8BgERhJ5HdZSKc
    - PUBLIC_URI=https://console-stg.cloud.vmware.com
