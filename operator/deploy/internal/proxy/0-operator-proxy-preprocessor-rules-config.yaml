# User supplied preprocessor rules are merged into this configmap at runtime.
apiVersion: v1
kind: ConfigMap
metadata:
  name: operator-proxy-preprocessor-rules-config
  namespace: {{ .Namespace }}
  labels:
    app.kubernetes.io/name: wavefront
    app.kubernetes.io/component: proxy
  ownerReferences:
  - apiVersion: apps/v1
    kind: Deployment
    name: wavefront-controller-manager
    uid: {{ .ControllerManagerUID }}
data:
  rules.yaml: |
    {{ .DataExport.WavefrontProxy.PreprocessorRules.EnabledPorts }},49151:
    - rule: noop-rule
      action: count
{{- if .DataExport.WavefrontProxy.PreprocessorRules.UserDefinedPortRules }}
{{ .DataExport.WavefrontProxy.PreprocessorRules.UserDefinedPortRules | indent 4 }}
{{- end }}
    global:
{{- if .DataExport.WavefrontProxy.PreprocessorRules.UserDefinedGlobalRules }}
{{ .DataExport.WavefrontProxy.PreprocessorRules.UserDefinedGlobalRules | indent 4 }}
{{- end }}
    - rule: metrics-add-cluster-uuid
      action: addTag
      tag: cluster_uuid
      value: "{{ .ClusterUUID }}"
    - rule: metrics-add-cluster-name
      action: addTag
      tag: cluster
      value: "{{ .ClusterName }}"
    - rule: span-drop-cluster-uuid
      action: spanDropTag
      key: cluster_uuid
    - rule: span-add-cluster-uuid
      action: spanAddTag
      key: cluster_uuid
      value: "{{ .ClusterUUID }}"
    - rule: span-drop-cluster-name
      action: spanDropTag
      key: cluster
    - rule: span-add-cluster-name
      action: spanAddTag
      key: cluster
      value: "{{ .ClusterName }}"
