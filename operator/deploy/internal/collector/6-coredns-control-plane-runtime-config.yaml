{{- if .DataCollection.Metrics.ControlPlane.Enable }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-control-plane-config
  namespace: {{ .Namespace }}
  ownerReferences:
  - apiVersion: apps/v1
    kind: Deployment
    name: wavefront-controller-manager
    uid: {{ .ControllerManagerUID }}
  annotations:
    wavefront.com/discovery-config: 'true'
data:
  collector.yaml: |
    plugins:
    - name: coredns-discovery
      type: prometheus
      selectors:
        images:
        - '*coredns:*'
        labels:
          k8s-app:
          - kube-dns
      port: 9153
      path: /metrics
      scheme: http
      prefix: kubernetes.controlplane.
      convertHistograms: true
      filters:
        metricAllowList:
        - 'kubernetes.controlplane.coredns.dns.request.duration.seconds.m'
        - 'kubernetes.controlplane.coredns.dns.responses.total.counter'
{{- end }}