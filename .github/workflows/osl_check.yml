name: Check PR for Package Diff

on:
  pull_request: {}

jobs:
  check_go_mods:
    runs-on: ubuntu-latest

    outputs:
      needs_osl: ${{ steps.diffCollector.outputs.needs_osl }}

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - id: diffCollector
      name: Diff Collector go.mod
      run: |
        git fetch --unshallow
        
        git diff v2.5.0..HEAD -- collector/go.mod | grep -e '^+\s' | awk '{print $2}' | sort > additions.txt
        git diff v2.5.0..HEAD -- collector/go.mod | grep -e '^-\s' | awk '{print $2}' | sort > removals.txt
        
        # failing exit code means there is a diff,
        # and we use that to determine if we need OSL,
        # but we don't want the whole pipeline to fail (hence "return true")
        (diff removals.txt additions.txt > diff_of_diffs.txt \
          && echo 'needs_osl=false' \
          || (echo 'needs_osl=true'; true) \
        ) > "$GITHUB_OUTPUT"

    - name: Comment OSL Warning
      if: steps.diffCollector.outputs.needs_osl == 'true'
      uses: actions/github-script@v5
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: |
              ðŸš¨ Warning: merging this PR will require a new OSL request! See diff below. ðŸš¨
  
              ${{cat diff_of_diffs.txt}}
          })
