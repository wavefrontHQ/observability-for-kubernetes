name: Check PR for Package Diff

on:
  pull_request: {}

jobs:
  check_go_mods:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - id: diffOperator
      name: Diff Operator go.mod
      run: |
        git fetch --unshallow
        
        git diff main..HEAD -- operator/go.mod | grep -e '^+\s' | awk '{print $2}' | sort > operator_additions.txt
        git diff main..HEAD -- operator/go.mod | grep -e '^-\s' | awk '{print $2}' | sort > operator_removals.txt
        
        # failing exit code means there is a diff,
        # and we use that to determine if we need OSL,
        # but we don't want the whole pipeline to fail (hence "return true")
        (diff operator_removals.txt operator_additions.txt > operator_diff_of_diffs.txt \
          && echo 'operator_needs_osl=false' \
          || (echo 'operator_needs_osl=true'; true) \
        ) >> "$GITHUB_OUTPUT"

    - id: diffCollector
      name: Diff Collector go.mod
      run: |
        git diff main..HEAD -- collector/go.mod | grep -e '^+\s' | awk '{print $2}' | sort > collector_additions.txt
        git diff main..HEAD -- collector/go.mod | grep -e '^-\s' | awk '{print $2}' | sort > collector_removals.txt
        
        (diff collector_removals.txt collector_additions.txt > collector_diff_of_diffs.txt \
          && echo 'collector_needs_osl=false' \
          || (echo 'collector_needs_osl=true'; true) \
        ) >> "$GITHUB_OUTPUT"

    - name: Comment Operator OSL Warning
      if: steps.diffOperator.outputs.operator_needs_osl == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs')
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸš¨ Warning: merging this PR will require a new OSL request for the Operator! See diff below. ðŸš¨
  
              ${ fs.readFileSync('./operator_diff_of_diffs.txt', {encoding: 'utf8', flag: 'r'}) }`
          })

    - name: Comment Collector OSL Warning
      if: steps.diffCollector.outputs.collector_needs_osl == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs')
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸš¨ Warning: merging this PR will require a new OSL request for the Collector, which will also require one for the Operator! See diff below. ðŸš¨
          
              ${ fs.readFileSync('./collector_diff_of_diffs.txt', {encoding: 'utf8', flag: 'r'}) }`
          })
