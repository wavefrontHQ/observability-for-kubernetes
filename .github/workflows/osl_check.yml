name: Check PR for Package Diff

on:
  pull_request: {}

jobs:
  check_go_mods:
    runs-on: ubuntu-latest

    outputs:
      needs_osl: ${{ steps.diffCollector.outputs.needs_osl }}

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - id: diffCollector
      name: Diff Collector go.mod
      run: |
        git fetch --unshallow
        
        git diff v2.5.0..HEAD -- collector/go.mod | grep -e '^+\s' | awk '{print $2}' | sort > additions.txt
        git diff v2.5.0..HEAD -- collector/go.mod | grep -e '^-\s' | awk '{print $2}' | sort > removals.txt
        
        # failing exit code means there is a diff,
        # and we use that to determine if we need OSL,
        # but we don't want the whole pipeline to fail (hence "return true")
        (diff removals.txt additions.txt > diff_of_diffs.txt \
          && echo 'needs_osl=false' \
          || (echo 'needs_osl=true'; true) \
        ) > "$GITHUB_OUTPUT"

#  test_outputs:
#    runs-on: ubuntu-latest
#    needs: check_go_mods
#    steps:
    - name: Comment
      if: steps.diffCollector.outputs.needs_osl == 'true'
      run: |
        echo 'ðŸš¨ Warning: merging this PR will require a new OSL request! See diff below. ðŸš¨'
        cat diff_of_diffs.txt

#  comment_osl_warning:
#    runs-on: ubuntu-latest
#    needs: diffCollector
#    steps:
#    - uses: actions/github-script@v5
#      with:
#        github-token: ${{secrets.GITHUB_TOKEN}}
#        script: |
#          github.rest.issues.createComment({
#            issue_number: context.issue.number,
#            owner: context.repo.owner,
#            repo: context.repo.repo,
#            body: |
#              ðŸš¨ Warning: merging this PR will require a new OSL request! See diff below. ðŸš¨
#
#              ${{needs.diffCollector.outputs.diff_of_diffs}}
#          })
#    if:


    #   check_component_versions:
    #     runs-on: ubuntu-latest

    #     steps:
    #     - name:

# opinions and questions:
# - it's good
# -